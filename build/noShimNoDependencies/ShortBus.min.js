!function(){define("amp/bus/Envelope",["underscore"],function(e){var t;return t=function(){function t(e,t){this.headers=null!=e?e:{},this.payload=null!=t?t:""}return t.prototype.equals=function(t){return t===this?!0:e.isNull(t)?!1:e.isString(t.payload)?t.payload!==this.payload?!1:e.isObject(t.headers)?e.isEqual(t.headers,this.headers)?!0:!1:!1:!1},t.prototype.toString=function(){return JSON.stringify(this)},t.prototype.getHeader=function(e){return this.headers[e]},t.prototype.setHeader=function(e,t){return this.headers[e]=t},t.prototype.getHeaders=function(){return this.headers},t.prototype.getPayload=function(){return this.payload},t.prototype.setPayload=function(e){this.payload=e},t}()}),define("amp/bus/berico/EnvelopeHeaderConstants",[],function(){var e;return e=function(){function e(){}return e.ENVELOPE_CREATION_TIME="cmf.bus.envelope.creation",e.ENVELOPE_RECEIPT_TIME="cmf.bus.envelope.receipt",e.MESSAGE_CORRELATION_ID="cmf.bus.message.correlation_id",e.MESSAGE_ID="cmf.bus.message.id",e.MESSAGE_PATTERN="cmf.bus.message.pattern",e.MESSAGE_PATTERN_PUBSUB="cmf.bus.message.pattern#pub_sub",e.MESSAGE_PATTERN_RPC="cmf.bus.message.pattern#rpc",e.MESSAGE_PATTERN_RPC_TIMEOUT="cmf.bus.message.pattern#rpc.timeout",e.MESSAGE_SENDER_IDENTITY="cmf.bus.message.sender_identity",e.MESSAGE_SENDER_SIGNATURE="cmf.bus.message.sender_signature",e.MESSAGE_TOPIC="cmf.bus.message.topic",e.MESSAGE_TYPE="cmf.bus.message.type",e.SENDER_AUTH_TOKEN="SENDER_AUTH_TOKEN",e}()}),define("amp/bus/berico/EnvelopeHelper",["./EnvelopeHeaderConstants","underscore"],function(e,t){var n;return n=function(){function n(e){this.envelope=e}return n.prototype.flatten=function(){return JSON.stringify(this.envelope.headers)},n.prototype.getCorrelationId=function(){return this.envelope.getHeader(e.MESSAGE_CORRELATION_ID)},n.prototype.getCreationTime=function(){return this.envelope.getHeader(e.ENVELOPE_CREATION_TIME)},n.prototype.getDigitalSignature=function(){return this.envelope.getHeader(e.MESSAGE_SENDER_SIGNATURE)},n.prototype.getEnvelope=function(){return this.envelope},n.prototype.getHeader=function(e){return this.envelope.getHeader(e)},n.prototype.getMessageId=function(){return this.envelope.getHeader(e.MESSAGE_ID)},n.prototype.getMessagePattern=function(){return this.envelope.getHeader(e.MESSAGE_PATTERN)},n.prototype.getMessageTopic=function(){return this.envelope.getHeader(e.MESSAGE_TOPIC)},n.prototype.getMessageType=function(){return this.envelope.getHeader(e.MESSAGE_TYPE)},n.prototype.getPayload=function(){return this.envelope.getPayload()},n.prototype.getReciptTime=function(){return this.envelope.getHeader(e.ENVELOPE_RECEIPT_TIME)},n.prototype.getRpcTimeout=function(){return this.envelope.getHeader(e.MESSAGE_PATTERN_RPC_TIMEOUT)},n.prototype.getSenderIdentity=function(){return this.envelope.getHeader(e.MESSAGE_SENDER_IDENTITY)},n.prototype.getSenderAuthToken=function(){return this.envelope.getHeader(e.SENDER_AUTH_TOKEN)},n.prototype.isPubSub=function(){return e.MESSAGE_PATTERN_PUBSUB===this.getMessagePattern()},n.prototype.isRequest=function(){return!t.isString(this.getCorrelationId&&this.getCorrelationId.length>0)&&this.isRpc},n.prototype.isRpc=function(){return e.MESSAGE_PATTERN_RPC===this.getMessagePattern()},n.prototype.setCorrelationId=function(t){return this.envelope.setHeader(e.MESSAGE_CORRELATION_ID,t)},n.prototype.setCreationTime=function(t){return this.envelope.setHeader(e.ENVELOPE_CREATION_TIME,t)},n.prototype.setDigitalSignature=function(t){return this.envelope.setHeader(e.MESSAGE_SENDER_SIGNATURE,t)},n.prototype.setHeader=function(e,t){return this.envelope.setHeader(e,t)},n.prototype.setMessageId=function(t){return this.envelope.setHeader(e.MESSAGE_ID,t)},n.prototype.setMessagePattern=function(t){return this.envelope.setHeader(e.MESSAGE_PATTERN,t)},n.prototype.setMessageTopic=function(t){return this.envelope.setHeader(e.MESSAGE_TOPIC,t)},n.prototype.setMessageType=function(t){return this.envelope.setHeader(e.MESSAGE_TYPE,t)},n.prototype.setPayload=function(e){return this.envelope.setPayload(e)},n.prototype.setReciptTime=function(t){return this.envelope.setHeader(e.ENVELOPE_RECEIPT_TIME,t)},n.prototype.setRpcTimeout=function(t){return this.envelope.setHeader(e.MESSAGE_PATTERN_RPC_TIMEOUT,t)},n.prototype.setSenderIdentity=function(t){return this.envelope.setHeader(e.MESSAGE_SENDER_IDENTITY,t)},n.prototype.setSenderAuthToken=function(t){return this.envelope.setHeader(e.SENDER_AUTH_TOKEN,t)},n}()}),define("amp/util/Logger",["flog"],function(e){var t;return t=function(){function t(){}var n;return t.loggingLevel=null!=(n=window.loggingLevel)?n:"none",t.log=function(){var n;return n=e.create(),n.setLevel(t.loggingLevel),n}(),t}()}),define("amp/connection/EnvelopeDispatcher",["underscore","../util/Logger"],function(e,t){var n;return n=function(){function n(e,t,n){this.registration=e,this.envelope=t,this.channel=n}return n.prototype.dispatch=function(n){return t.log.info("EnvelopeDispatcher.dispatch >> dispatching envelope"),e.isObject(n)||this.dispatch(this.envelope),this.registration.handle(n)},n.prototype.dispatchFailed=function(){},n}()}),define("amp/connection/Listener",["underscore","../bus/Envelope","../bus/berico/EnvelopeHelper","./EnvelopeDispatcher","jquery","../util/Logger"],function(e,t,n,r,o,i){var s;return s=function(){function s(e,t){this.registration=e,this.exchange=t}return s.prototype.envCallbacks=[],s.prototype.closeCallbacks=[],s.prototype.connectionErrorCallbacks=[],s.prototype.onEnvelopeReceived=function(e){return this.envCallbacks.push(e)},s.prototype.onClose=function(e){return this.closeCallbacks.push(e)},s.prototype.onConnectionError=function(e){return this.connectionErrorCallbacks.push(e)},s.prototype.start=function(t){var n;return this.channel=t,n=o.Deferred(),i.log.info("Listener.start >> subscribing to /queue/"+this.exchange.queueName),t.subscribe("/amq/queue/"+this.exchange.queueName,e.bind(this.handleNextDelivery,this)),n.resolve(),n.promise()},s.prototype.handleNextDelivery=function(e){var t;return i.log.info("Listener.handleNextDelivery >> received a message"),t=this.createEnvelopeFromDeliveryResult(e),this.shouldRaiseEvent(this.registration,t)?(i.log.info("Listener.handleNextDelivery >> raising event from received message"),this.dispatchEnvelope(t.getEnvelope())):void 0},s.prototype.dispatchEnvelope=function(e){var t;return t=new r(this.registration,e,this.channel),this.raise_onEnvelopeRecievedEvent(t)},s.prototype.raise_onEnvelopeRecievedEvent=function(e){var t,n,r,o,i;for(o=this.envCallbacks,i=[],n=0,r=o.length;r>n;n++)t=o[n],i.push(t.handleRecieve(e));return i},s.prototype.shouldRaiseEvent=function(t,n){var r,o;return-1!==n.getMessageTopic().indexOf(t.eventHandler.getEventType())?(o=t.filterPredicate,r=n.getEnvelope(),e.isNull(o)||!e.isObject(o)?!0:o.filter(r)):!1},s.prototype.createEnvelopeFromDeliveryResult=function(r){var o,i,s,a,u;for(o=new n(new t),o.setReciptTime((new Date).getMilliseconds),o.setPayload(r.body),u=e.keys(r.headers),s=0,a=u.length;a>s;s++)i=u[s],o.setHeader(i,r.headers[i]);return o},s.prototype.dispose=function(){},s}()}),define("amp/connection/TransportProvider",["./Listener","underscore","jquery","../util/Logger"],function(e,t,n,r){var o;return o=function(){function o(e){var t,n;e=null!=e?e:{},this.topologyService=null!=(t=e.topologyService)?t:{},this.channelProvider=null!=(n=e.channelProvider)?n:{}}return o.prototype.listeners={},o.prototype.envCallbacks=[],o.prototype.register=function(e){var o,i,s=this;return r.log.info("TransportProvider.register >> registering new connection"),o=n.Deferred(),i=[],this.topologyService.getRoutingInfo(e.registrationInfo).then(function(a){var u,c,l,p,f;for(c=t.pluck(a.routes,"consumerExchange"),p=0,f=c.length;f>p;p++)u=c[p],l=n.Deferred(),i.push(l),s._createListener(e,u).then(function(t){return l.resolve(),s.listeners[e]=t});return n.when.apply(n,i).done(function(){return r.log.info("TransportProvider.register >> all listeners have been created"),o.resolve()})}),o.promise()},o.prototype._createListener=function(e,t){var o,i=this;return o=n.Deferred(),this.channelProvider.getConnection(t).then(function(n){var s;return s=i._getListener(e,t),s.onEnvelopeReceived({handleRecieve:function(e){return r.log.info("TransportProvider._createListener >> handleRecieve called"),i.raise_onEnvelopeRecievedEvent(e)}}),s.onClose({onClose:function(e){return delete i.listeners[e]}}),s.start(n).then(function(){return r.log.info("TransportProvider._createListener >> listener started"),o.resolve(s)})}),o.promise()},o.prototype._getListener=function(t,n){return new e(t,n)},o.prototype._send=function(e,t,n,r){return e.send("/exchange/"+t.name+"/"+t.routingKey,n,r.getPayload())},o.prototype.send=function(e){var o,i,s=this;return o=n.Deferred(),i=[],this.topologyService.getRoutingInfo(e.getHeaders(),!1).then(function(a){var u,c,l,p,f;for(l=t.pluck(a.routes,"producerExchange"),p=0,f=l.length;f>p;p++)u=l[p],c=n.Deferred(),i.push(c),s.channelProvider.getConnection(u).then(function(t){var n,o,i;i={},o=e.getHeaders();for(n in o)i[n]=o[n];return r.log.info("TransportProvider.send >> sending message to /exchange/"+u.name+"/"+u.routingKey),s._send(t,u,i,e),c.resolve()});return n.when.apply(n,i).done(function(){return o.resolve()})}),o.promise()},o.prototype.unregister=function(e){return delete this.listeners[e]},o.prototype.onEnvelopeRecieved=function(e){return this.envCallbacks.push(e)},o.prototype.raise_onEnvelopeRecievedEvent=function(e){var t,n,r,o,i;for(o=this.envCallbacks,i=[],n=0,r=o.length;r>n;n++)t=o[n],i.push(t.handleRecieve(e));return i},o.prototype.dispose=function(){var e,t,r,o,i;e=n.Deferred(),r=[],r.push(this.channelProvider.dispose()),r.push(this.topologyService.dispose()),i=this.listeners;for(o in i)t=i[o],r.push(t.dispose());return n.when.apply(n,r).done(function(){return e.resolve()}),e.promise()},o}()}),define("amp/connection/topology/DefaultAuthenticationProvider",["jquery","underscore","../../util/Logger"],function(e,t,n){var r;return r=function(){function r(e){null==e&&(e={}),this.hostname=e.hostname,this.port=e.port,this.serviceUrl=e.serviceUrl,this.connectionStrategy=e.connectionStrategy,t.isString(this.hostname)||(this.hostname="localhost"),t.isNumber(this.port)||(this.port=15679),t.isString(this.serviceUrl)||(this.serviceUrl="/anubis/identity/authenticate"),t.isFunction(this.connectionStrategy)||(this.connectionStrategy=function(){return"https://"+this.hostname+":"+this.port+this.serviceUrl})}return r.prototype.username=null,r.prototype.password=null,r.prototype.getCredentials=function(){var n,r=this;return n=e.Deferred(),t.isNull(this.username)||t.isNull(this.password)?this._authenticate().then(function(){return n.resolve({username:r.username,password:r.password})}):n.resolve({username:this.username,password:this.password}),n.promise()},r.prototype._authenticate=function(){var r,o,i=this;return r=e.Deferred(),o=e.ajax({url:this.connectionStrategy(),dataType:"jsonp"}),o.done(function(e){return n.log.info("DefaultAuthenticationProvider.authenticate >> successfully completed request"),t.isObject(e)?(t.isString(e.identity)&&(i.username=e.identity),t.isString(e.token)&&(i.password=e.token),r.resolve(e)):r.reject()}),o.fail(function(){return n.log.error("DefaultAuthenticationProvider.authenticate >> failed complete request"),r.reject()}),r.promise()},r}()}),define("amp/connection/ChannelProvider",["stomp","../util/Logger","sockjs","underscore","jquery","./topology/DefaultAuthenticationProvider"],function(e,t,n,r,o,i){var s;return s=function(){function s(o){null==o&&(o={}),this.connectionStrategy=o.connectionStrategy,this.connectionFactory=o.connectionFactory,this.authenticationProvider=o.authenticationProvider,this.messagingFactory=o.messagingFactory,r.isFunction(this.connectionStrategy)||(this.connectionStrategy=s.DefaultConnectionStrategy),r.isFunction(this.connectionFactory)||(this.connectionFactory=n),r.isFunction(this.messagingFactory)||(this.messagingFactory=function(t){return e.over(t)}),r.isObject(this.authenticationProvider)||(this.authenticationProvider=new i),t.log.info("ChannelProvider.ctor >> instantiated.")}return s.DefaultConnectionStrategy=function(e){return"https://"+e.hostName+":"+e.port+e.vHost},s.prototype.connectionPool={},s.prototype.getConnection=function(e){var n,r,i,s=this;return i=o.Deferred(),t.log.info("ChannelProvider.getConnection >> Getting exchange"),r=this.connectionStrategy(e),n=this.connectionPool[r],null==n?(t.log.info("ChannelProvider.getConnection >> could not find existing connection"),this._createConnection(e,i),i.then(function(e){return s.connectionPool[r]=e})):(t.log.info("ChannelProvider.getConnection >> returning existing connection"),i.resolve(n,!0)),i.promise()},s.prototype.removeConnection=function(e){var n,r,i,s=this;return i=o.Deferred(),t.log.info("ConnectionFactory.removeConnection >> Removing connection"),r=this.connectionStrategy(e),n=this.connectionPool[r],null!=n?n.disconnect(function(){return delete s.connectionPool[r],i.resolve(!0)}):i.reject(!1)},s.prototype._createConnection=function(e,n){var r=this;return t.log.info("ChannelProvider._createConnection >> attempting to create a new connection"),this.authenticationProvider.getCredentials().then(function(o){var i,s,a,u;return a=o.username,s=o.password,u=new r.connectionFactory(r.connectionStrategy(e)),i=r.messagingFactory(u),i.heartbeat={outgoing:0,incoming:0},i.connect(a,s,function(){return t.log.info("ChannelProvider._createConnection >> successfully connected"),n.resolve(i,!1)},function(e){var r;return r="ChannelProvider._createConnection >> "+e,t.log.error("ChannelProvider._createConnection >> unable to connect: "+e),n.reject(r),t.log.error(r)}),n.promise()})},s.prototype.dispose=function(){var e,n,r,i,s,a,u;for(t.log.info("ChannelProvider.dispose >> clearing connections"),r=o.Deferred(),i=[],u=this.connectionPool,s=0,a=u.length;a>s;s++)e=u[s],n=o.Deferred(),i.push(n),e.disconnect(function(){return n.resolve()});return o.when.apply(o,i).done(function(){return r.resolve()}),r.promise()},s}()}),define("amp/connection/topology/RoutingInfo",[],function(){var e;return e=function(){function e(e){this.routes=e}return e}()}),define("amp/connection/topology/RouteInfo",[],function(){var e;return e=function(){function e(e,t){this.producerExchange=e,this.consumerExchange=t}return e}()}),define("amp/connection/topology/Exchange",[],function(){var e;return e=function(){function e(e,t,n,r,o,i,s,a,u,c){this.name=e,this.hostName=t,this.vHost=n,this.port=r,this.routingKey=o,this.queueName=i,this.exchangeType=s,this.isDurable=a,this.isAutoDelete=u,this.arguments=c}return e.prototype.toString=function(){return"{Name: "+this.name+", HostName: "+this.hostName+", VirtualHost: "+this.vHost+", Port: "+this.port+", RoutingKey: "+this.routingKey+", Queue Name: "+this.queueName+", ExchangeType: "+this.exchangeType+", IsDurable: "+this.isDurable+", IsAutoDelete: "+this.isAutoDelete+"}"},e.prototype.equals=function(e){return _.isObject(e)?e.name!==this.name?!1:e.hostName!==this.hostName?!1:e.vHost!==this.vHost?!1:e.port!==this.port?!1:!0:!1},e}()}),define("amp/connection/topology/SimpleTopologyService",["uuid","../../util/Logger","./RoutingInfo","./RouteInfo","./Exchange","underscore","../../bus/berico/EnvelopeHeaderConstants","jquery"],function(e,t,n,r,o,i,s,a){var u;return u=function(){function t(t){null==t&&(t={}),this.clientProfile=t.clientProfile,this.name=t.name,this.hostname=t.hostname,this.virtualHost=t.virtualHost,this.port=t.port,this.queue_number=t.queue_number,i.isString(this.clientProfile)||(this.clientProfile=e.v4()),i.isString(this.name)||(this.name="cmf.simple.exchange"),i.isString(this.hostname)||(this.hostname="127.0.0.1"),i.isString(this.virtualHost)||(this.virtualHost="/stomp"),i.isNumber(this.port)||(this.port=15678),i.isNumber(this.queue_number)||(this.queue_number=0)}return t.prototype.getRoutingInfo=function(e,t){var i,u,c,l;return i=a.Deferred(),l=e[s.MESSAGE_TOPIC],u=new o(this.name,this.hostname,this.virtualHost,this.port,l,this.buildIdentifiableQueueName(l),"direct",!1,!0,null),c=new r(u,u),t?this.createRoute(u).then(function(){return i.resolve(new n([c]))}):setTimeout(function(){return i.resolve(new n([c]))},1),i.promise()},t.prototype.createRoute=function(){var e;return e=a.Deferred(),e.resolve(null),e.promise()},t.prototype.buildIdentifiableQueueName=function(e){return-1===e.indexOf("#")?""+this.clientProfile+"#"+this.pad(++this.queue_number,3,0)+"#"+e:e},t.prototype.pad=function(e,t,n){return n=n||"0",e+="",e.length>=t?e:new Array(t-e.length+1).join(n)+e},t.prototype.dispose=function(){},t}()}),define("amp/bus/berico/TransportProviderFactory",["../../connection/TransportProvider","../../connection/ChannelProvider","../../connection/topology/SimpleTopologyService","underscore","../../util/Logger"],function(e,t,n,r,o){var i;return i=function(){function i(){}return i.TransportProviders={WebStomp:"webstomp"},i.TopologyServices={Simple:"simple"},i.ChannelFactories={WebStomp:"webstomp"},i.getTransportProvider=function(s){var a,u;if(o.log.info("TransportFactory.getTransportProvider >> getting transport provider"),!r.isObject(s)&&r.isString(s)&&(s={transportProvider:s}),!r.isObject(s.topologyService)&&r.isString(s.topologyService))switch(s.topologyService){case i.TopologyServices.Simple:u=new n}else r.isObject(s.topologyService)&&(u=s.topologyService);if(!r.isObject(s.channelProvider)&&r.isString(s.channelProvider))switch(s.channelProvider){case i.ChannelFactories.WebStomp:a=new t}else r.isObject(s.channelProvider)&&(a=s.channelProvider);switch(s.transportProvider){case i.TransportProviders.WebStomp:return r.isObject(u)||o.log.info("TransportFactory.getTransportProvider >> using default topology service"),r.isObject(u)||(u=new n),r.isObject(a)||o.log.info("TransportFactory.getTransportProvider >> using default channel provider"),r.isObject(a)||(a=new t),s={topologyService:u,channelProvider:a},new e(s)}},i}()}),define("amp/connection/topology/GlobalTopologyService",["../../util/Logger","LRUCache","underscore","../../bus/berico/EnvelopeHeaderConstants","jquery"],function(e,t,n,r,o){var i;return i=function(){function i(e){var r;null==e&&(e={}),this.routingInfoRetriever=e.routingInfoRetriever,r=e.cacheExpiryTime,this.fallbackProvider=e.fallbackProvider,this.exchangeOverrides=e.exchangeOverrides,n.isObject(this.exchangeOverrides)||(this.exchangeOverrides={port:15678,vHost:"/stomp"}),this.routingInfoCache=new t({maxAge:n.isNumber(r)?r:i.CACHE_EXPIRY_TIME_IN_MS})}return i.CACHE_EXPIRY_TIME_IN_MS=1e6,i.prototype.routingInfoCache={},i.prototype.fallbackProvider=null,i.prototype.getRoutingInfo=function(t,i){var s,a,u,c=this;return null==i&&(i=!0),s=o.Deferred(),u=t[r.MESSAGE_TOPIC],e.log.info("GlobalTopologyService.getRoutingInfo>> Getting routing info for topic: "+u),a=this.routingInfoCache.get(u),n.isUndefined(a)?(e.log.info("GlobalTopologyService.getRoutingInfo>> route not in cache, attempting external lookup"),this.routingInfoRetriever.retrieveRoutingInfo(u).then(function(t){return n.has(t,"routes")&&n.size(t.routes)>0?(e.log.info("GlobalTopologyService.getRoutingInfo>> Successfully retrieved "+n.size(t.routes)+" GTS routes"),c._fixExhangeInformation(t),c.routingInfoCache.set(u,t),s.resolve(t)):(e.log.info("GlobalTopologyService.getRoutingInfo>> no route in GTS: using fallback route"),c.fallbackProvider.getFallbackRoute(u,i).then(function(e){return s.resolve(e)}))})):(e.log.info("GlobalTopologyService.getRoutingInfo>> cache hit, returning route without lookup"),s.resolve(a)),s.promise()},i.prototype._fixExhangeInformation=function(e){var t,n,r,o,i,s,a;for(s=e.routes,a=[],o=0,i=s.length;i>o;o++)n=s[o],a.push(function(){var e,o;e=this.exchangeOverrides,o=[];for(t in e)r=e[t],n.consumerExchange[t]=r,o.push(n.producerExchange[t]=r);return o}.call(this));return a},i}()});var e={}.hasOwnProperty,t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};define("amp/connection/topology/DefaultApplicationExchangeProvider",["./SimpleTopologyService","../../bus/berico/EnvelopeHeaderConstants","../../util/Logger"],function(e,n,r){var o;return o=function(e){function o(e){var t,n,r,i,s;null==e&&(e={}),this.managementHostname=e.managementHostname,this.managementPort=e.managementPort,this.managementServiceUrl=e.managementServiceUrl,this.connectionStrategy=e.connectionStrategy,t=e.clientProfile,r=e.exchangeName,n=e.exchangeHostname,s=e.exchangeVhost,i=e.exchangePort,_.isString(this.managementHostname)||(this.managementHostname="localhost"),_.isNumber(this.managementPort)||(this.managementPort=15677),_.isString(this.managementServiceUrl)||(this.managementServiceUrl="/service/fallbackRouting/routeCreator"),_.isFunction(this.connectionStrategy)||(this.connectionStrategy=function(){return"https://"+this.managementHostname+":"+this.managementPort+this.managementServiceUrl}),o.__super__.constructor.call(this,{clientProfile:t,name:r,hostname:n,vhost:s,port:i})}return t(o,e),o.prototype.getFallbackRoute=function(e,t){var r;return null==t&&(t=!0),r=[],r[n.MESSAGE_TOPIC]=e,this.getRoutingInfo(r,t)},o.prototype.createRoute=function(e){var t,n;return t=$.Deferred(),n=$.ajax({url:this.connectionStrategy(),dataType:"jsonp",data:{data:JSON.stringify(e)}}),n.done(function(e){return r.log.info("DefaultApplicationExchangeProvider.createRoute >> created route"),t.resolve(e)}),n.fail(function(){return r.log.error("DefaultApplicationExchangeProvider.createRoute >> failed to create route"),t.reject()}),t.promise()},o}(e)}),define("amp/bus/berico/InboundEnvelopeProcessorCallback",["../../util/Logger"],function(e){var t;return t=function(){function t(e){this.envelopeBus=e}return t.prototype.handleRecieve=function(t){var n;return e.log.info("InboundEnvelopeProcessorCallback.handleRecieve >> received a message"),n=t.envelope,this.envelopeBus.processInbound(n),t.dispatch(n)},t}()}),define("amp/bus/berico/EnvelopeBus",["underscore","../berico/InboundEnvelopeProcessorCallback","../../util/Logger"],function(e,t,n){var r;return r=function(){function r(e,t,n){this.transportProvider=e,this.inboundProcessors=null!=t?t:[],this.outboundProcessors=null!=n?n:[],this.initialize()}return r.prototype.dispose=function(){var e,t,n,r,o,i,s,a;for(i=this.inboundProcessors,t=0,r=i.length;r>t;t++)e=i[t],e.dispose();for(s=this.outboundProcessors,a=[],n=0,o=s.length;o>n;n++)e=s[n],a.push(e.dispose());return a},r.prototype.initialize=function(){return n.log.info("EnvelopeBus.initialize >> initialized"),this.transportProvider.onEnvelopeRecieved(new t(this))},r.prototype.processInbound=function(e){var t,r,o,i,s,a;for(n.log.info("EnvelopeBus.processInbound >> executing processors"),t={},s=this.inboundProcessors,a=[],o=0,i=s.length;i>o;o++)r=s[o],a.push(r.processInbound(e,t));return a},r.prototype.processOutbound=function(e){var t,r,o,i,s,a,u;for(n.log.info("EnvelopeBus.processOutbound >> executing processors"),t={},r=$.Deferred(),o=$.Deferred().resolve(),u=this.outboundProcessors,s=0,a=u.length;a>s;s++)i=u[s],o=o.then(function(){return i.processOutbound(e,t)});return o.then(function(){return n.log.info("EnvelopeBus.processOutbound >> all outbound processors executed"),r.resolve()}),r.promise()},r.prototype.register=function(t){return e.isNull(t)?void 0:this.transportProvider.register(t)},r.prototype.send=function(e){var t=this;return n.log.info("EnvelopeBus.send >> sending envelope"),this.processOutbound(e).then(function(){return t.transportProvider.send(e)})},r.prototype.setInboundProcessors=function(e){this.inboundProcessors=e},r.prototype.setOutboundProcessors=function(e){this.outboundProcessors=e},r.prototype.unregister=function(e){return this.transportProvider.unregister(e)},r}()}),define("amp/eventing/berico/serializers/JsonEventSerializer",["../../../bus/berico/EnvelopeHelper","../../../util/Logger"],function(e,t){var n;return n=function(){function n(){}return n.prototype.processInbound=function(n){var r;return t.log.info("JsonEventSerializer.processInbound >> deserializing payload"),r=new e(n.getEnvelope()),n.setEvent(JSON.parse(r.getPayload()))},n.prototype.processOutbound=function(e){return t.log.info("JsonEventSerializer.processOutbound >> serializing payload"),e.getEnvelope().setPayload(JSON.stringify(e.getEvent()))},n}()}),define("amp/eventing/berico/OutboundHeadersProcessor",["../../bus/berico/EnvelopeHelper","uuid","underscore","../../util/Logger","../../connection/topology/DefaultAuthenticationProvider","jquery"],function(e,t,n,r,o,i){var s;return s=function(){function s(e){null==e&&(e={}),this.authenticationProvider=e.authenticationProvider,n.isObject(this.authenticationProvider)||(this.authenticationProvider=new o)}return s.prototype.userInfoRepo=null,s.prototype.processOutbound=function(o){var s,a,u,c,l,p,f;return a=i.Deferred(),f=[],r.log.info("OutboundHeadersProcessor.processOutbound >> adding headers"),u=new e(o.getEnvelope()),c=n.isString(u.getMessageId())?u.getMessageId():t.v4(),u.setMessageId(c),s=u.getCorrelationId(),p=u.getMessageType(),p=n.isString(p)?p:this.getMessageType(o.getEvent()),u.setMessageType(p),l=u.getMessageTopic(),l=n.isString(l)?l:this.getMessageTopic(o.getEvent()),u.setMessageTopic(l),f.push(this.getAnubisCredentials(u.getSenderIdentity(),u.getSenderAuthToken()).then(function(e){return u.setSenderIdentity(e.username),u.setSenderAuthToken(e.token)})),i.when.apply(i,f).done(function(){return a.resolve()}),a.promise()},s.prototype.getAnubisCredentials=function(e,t){var o;return o=i.Deferred(),n.isString(e)&&n.isString(t)?(r.log.info("OutboundHeadersProcessor.getUsername >> using username from envelope: "+e),o.resolve({username:e,token:t})):this.authenticationProvider.getCredentials().then(function(e){return r.log.info("OutboundHeadersProcessor.getUsername >> using username from authenticationProvider: "+e.username),o.resolve({username:e.username,token:e.password})}),o.promise()},s.prototype.getMessageType=function(e){var t;return t=Object.getPrototypeOf(e).constructor.name,r.log.info("OutboundHeadersProcessor.getMessageType >> inferring type as "+t),t},s.prototype.getMessageTopic=function(e){var t;return t=Object.getPrototypeOf(e).constructor.name,r.log.info("OutboundHeadersProcessor.getMessageTopic >> inferring topic as "+t),t},s}()}),define("amp/eventing/berico/ProcessingContext",[],function(){var e;return e=function(){function e(e,t){this.env=e,this.event=t}return e.prototype.properties={},e.prototype.getEnvelope=function(){return this.env},e.prototype.getEvent=function(){return this.event},e.prototype.getProperty=function(e){return this.properties[e]},e.prototype.setEnvelope=function(e){return this.env=e},e.prototype.setEvent=function(e){return this.event=e},e.prototype.setProperties=function(e){this.properties=e},e.prototype.setProperty=function(e,t){return this.properties[e]=t},e}()}),define("amp/eventing/berico/EventRegistration",["../../bus/berico/EnvelopeHeaderConstants","./ProcessingContext","../../util/Logger"],function(e,t,n){var r;return r=function(){function r(t,n){this.eventHandler=t,this.inboundChain=n,this.registrationInfo[e.MESSAGE_TOPIC]=t.getEventType()}return r.prototype.filterPredicate=null,r.prototype.registrationInfo={},r.prototype.handle=function(e){var r,o;return n.log.info("EventRegistration.handle >> received new envelope"),r={},o=new t(e,r),this.processInbound(o)?this.eventHandler.handle(o.getEvent(),o.getEnvelope().getHeaders()):void 0},r.prototype.processInbound=function(e){var t,r,o,i,s;for(n.log.info("EventRegistration.processInbound >> processing inbound queue"),t=!0,s=this.inboundChain,o=0,i=s.length;i>o&&(r=s[o],r.processInbound(e)||(r=!1),r);o++);return t},r.prototype.handleFailed=function(e,t){return eventHandler.handleFailed(e,t)},r}()}),define("amp/eventing/berico/EventBus",["./ProcessingContext","../../bus/Envelope","./EventRegistration","../../util/Logger","jquery","../../bus/berico/EnvelopeHelper","../../bus/berico/EnvelopeHeaderConstants","underscore"],function(e,t,n,r,o,i,s,a){var u;return u=function(){function u(e,t,n){this.envelopeBus=e,this.inboundProcessors=null!=t?t:[],this.outboundProcessors=null!=n?n:[]}return u.prototype.dispose=function(){return this.envelopeBus.dispose()},u.prototype.finalize=function(){return this.dispose()},u.prototype.processOutbound=function(t,n){var i,s,a,u,c,l,p;for(r.log.info("EventBus.processOutbound >> executing processors"),i=new e(n,t),s=o.Deferred(),a=o.Deferred().resolve(),p=this.outboundProcessors,c=0,l=p.length;l>c;c++)u=p[c],a=a.then(function(){return u.processOutbound(i)});return a.then(function(){return r.log.info("EventBus.processOutbound >> all outbound processors executed"),s.resolve()}),s.promise()},u.prototype.publish=function(e,n){var r,o,u=this;return r=new t,o=new i(r),o.setMessagePattern(s.MESSAGE_PATTERN_PUBSUB),a.isString(n)&&(o.setMessageType(n),o.setMessageTopic(n)),this.processOutbound(e,r).then(function(){return u.envelopeBus.send(r)})},u.prototype.subscribe=function(e){var t;return t=new n(e,this.inboundProcessors),this.envelopeBus.register(t)},u}()}),define("amp/connection/topology/RoutingInfoRetriever",["../../util/Logger","jquery"],function(e){var t;return t=function(){function t(e){null==e&&(e={}),this.hostname=e.hostname,this.port=e.port,this.serviceUrlExpression=e.serviceUrlExpression,this.connectionStrategy=e.connectionStrategy,_.isString(this.hostname)||(this.hostname="127.0.0.1"),_.isNumber(this.port)||(this.port=15677),_.isString(this.serviceUrlExpression)||(this.serviceUrlExpression="/service/topology/get-routing-info"),_.isFunction(this.connectionStrategy)||(this.connectionStrategy=function(e){return"https://"+this.hostname+":"+this.port+this.serviceUrlExpression+"/"+e+"?c=true"})}return t.prototype.retrieveRoutingInfo=function(t){var n,r;return e.log.info("RoutingInfoRetriever.retrieveRoutingInfo >> Getting routing info for topic: "+t),n=$.Deferred(),r=$.ajax({url:this.connectionStrategy(t),dataType:"jsonp"}),r.done(function(t){return e.log.info("RoutingInfoRetriever.retrieveRoutingInfo >> retrieved topic info"),n.resolve(t)}),r.fail(function(){return e.log.error("RoutingInfoRetriever.retrieveRoutingInfo >> failed to retrieve topic info"),n.reject()}),n.promise()},t}()}),define("amp/connection/topology/DefaultIdentityProvider",["jquery","underscore","../../util/Logger"],function(e,t,n){var r;return r=function(){function r(e){null==e&&(e={}),this.hostname=e.hostname,this.port=e.port,this.serviceUrl=e.serviceUrl,this.connectionStrategy=e.connectionStrategy,t.isString(this.hostname)||(this.hostname="localhost"),t.isNumber(this.port)||(this.port=15679),t.isString(this.serviceUrl)||(this.serviceUrl="/anubis/identity/identify"),t.isFunction(this.connectionStrategy)||(this.connectionStrategy=function(){return"https://"+this.hostname+":"+this.port+this.serviceUrl})}return r.prototype.getIdentity=function(r){var o,i;return null==r&&(r=""),o=e.Deferred(),i=e.ajax({url:this.connectionStrategy(),dataType:"jsonp",data:r}),i.done(function(e){return n.log.info("DefaultIdentityProvider.getIdentity >> successfully completed request"),t.isObject(e)?o.resolve(e):o.reject()}),i.fail(function(){return n.log.error("DefaultIdentityProvider.getIdentity >> failed complete request"),o.reject()}),o.promise()},r}()});var e={}.hasOwnProperty,t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};define("amp/eventing/berico/RpcRegistration",["../../bus/berico/EnvelopeHelper","jquery","./ProcessingContext","./EventRegistration","../../util/Logger","../../bus/berico/EnvelopeHeaderConstants"],function(e,n,r,o,i,s){var a;return a=function(o){function a(t){var r,o;null==t&&(t={}),o=t.requestId,r=t.expectedTopic,this.inboundChain=t.inboundChain,this.eventHandler={getEventType:function(){return r}},this.responseFilter={filter:function(t){return new e(t).getCorrelationId()===o}},this.registrationInfo={},this.registrationInfo[s.MESSAGE_TOPIC]=this.buildRpcTopic(r,o),this.requestDeferred=n.Deferred()
}return t(a,o),a.prototype.buildRpcTopic=function(e,t){var n;return n=""+e+"#"+t,i.log.info("RpcRegistration.buildRpcTopic >> rpc topic is "+n),n},a.prototype.getResponse=function(){return this.requestDeferred.promise()},a.prototype.handle=function(e){var t;return i.log.info("RpcRegistration.handle >> received new envelope"),t=new r(e,e),this.processInbound(t)?this.requestDeferred.resolve(t.getEvent()):void 0},a}(o)});var e={}.hasOwnProperty,t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};define("amp/eventing/berico/RpcBus",["./EventBus","../../util/Logger","uuid","../../bus/Envelope","../../bus/berico/EnvelopeHelper","../../bus/berico/EnvelopeHeaderConstants","./RpcRegistration","jquery"],function(e,n,r,o,i,s,a,u){var c,l;return c=function(e){function c(){return l=c.__super__.constructor.apply(this,arguments)}return t(c,e),c.prototype.getResponseTo=function(e){var t,o,i,s,c,l,p,f=this;return null==e&&(e={}),c=e.request,p=e.timeout,s=e.outboundTopic,i=e.inboundTopic,n.log.info("RpcBus.getResponseTo >> executing get response"),t=u.Deferred(),l=r.v4(),o=this.buildRequestEnvelope(l,p,s),this.processOutbound(c,o).then(function(){var e;return e=new a({requestId:l,expectedTopic:i,inboundChain:f.inboundProcessors}),f.envelopeBus.register(e).then(function(){return f.envelopeBus.send(o),e.getResponse().then(function(n){return f.envelopeBus.unregister(e),t.resolve(n)})})}),t.promise()},c.prototype.buildRequestEnvelope=function(e,t,n){var r,a;return r=new o,a=new i(r),_.isString(n)&&(a.setMessageType(n),a.setMessageTopic(n)),a.setMessageId(e),a.setMessagePattern(s.MESSAGE_PATTERN_RPC),a.setRpcTimeout(t),r},c}(e)}),define("amp/util/AesUtil",["CryptoJS_AES","CryptoJS_PBKDF2","CryptoJS_ENC_BASE64"],function(){var e;return e=function(){function e(e,t){this.keySize=e/32,this.iterationCount=t}return e.prototype.generateKey=function(e,t){var n;return e=CryptoJS.enc.Hex.parse(e),n={keySize:this.keySize,iterations:this.iterationCount,hasher:CryptoJS.algo.SHA384},CryptoJS.PBKDF2(t,e,n)},e.prototype.encrypt=function(e,t,n,r){var o,i;return i=this.generateKey(e,n),o=CryptoJS.AES.encrypt(r,i,{iv:CryptoJS.enc.Hex.parse(t)}),o.ciphertext.toString(CryptoJS.enc.Base64)},e.prototype.decrypt=function(e,t,n,r){var o,i,s;return s=this.generateKey(e,n),o=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(r)}),i=CryptoJS.AES.decrypt(o,s,{iv:CryptoJS.enc.Hex.parse(t)}),i.toString(CryptoJS.enc.Utf8)},e}()}),define("amp/connection/topology/DefaultMessagingKeystore",["jquery","underscore","../../util/Logger","Hashtable"],function(e,t,n,r){var o;return o=function(){function e(){var e;e=new r,this.getPublicKey=function(n){var r;return r=e.get(n),t.isNull(r)?null:r.publicKey},this.getPrivateKey=function(n){var r;return r=e.get(n),t.isNull(r)?null:r.privateKey},this.hasKeypair=function(n){return!t.isNull(e.get(n))},this.setKeypair=function(t,n){var r,o;return o=n.publicKey,r=n.privateKey,e.put(t,{privateKey:n.privateKey,publicKey:n.publicKey})}}return e}()}),define("amp/eventing/berico/handlers/EncryptedResponseHandler",["../../../bus/berico/EnvelopeHelper","../../../util/Logger","JSEncrypt","amp/util/AesUtil","amp/connection/topology/DefaultMessagingKeystore"],function(e,t,n,r,o){var i;return i=function(){function i(e){null==e&&(e={}),this.keystore=e.keystore,_.isObject(this.keystore)||(this.authenticationProvider=new o)}return i.prototype.processInbound=function(o){var i,s,a,u,c,l,p,f,h,d,g,v,y;return l=new e(o.getEnvelope()),l.isPubSub()?(t.log.info("EncryptedResponseHandler.processInbound >>  message is pubsub, proceeding with decryption"),s=JSON.parse(l.getSenderAuthToken()),c=new n,v=this.keystore.getPrivateKey(l.getMessageTopic()),c.setPrivateKey(v),g=c.decrypt(s.key).replace(/(\r\n|\n|\r)/gm,""),g===!1?t.log.info("EncryptedResponseHandler.processInbound >> failed to decrypt passphrase"):(h="F27D5C9927726BCEFE7510B1BDD3D137",y="3FF2EC019C627B945225DEBAD71A01B6985FE84C95A70EB132882F88C0A59A55",d=256,f=p=1e3,i=new r(d,p),a=l.getPayload(),u=i.decrypt(y,h,g,a),u.length>0?(t.log.info("EncryptedResponseHandler.processInbound >> successfully decrypted message"),l.setPayload(u),!0):(t.log.info("EncryptedResponseHandler.processInbound >> failed to decrypt message"),!1))):t.log.info("EncryptedResponseHandler.processInbound >>  message is not pubsub, ignoring")},i.prototype.processOutbound=function(){return null},i}()}),define("amp/eventing/berico/handlers/EncryptedRequestHandler",["jquery","../../../bus/berico/EnvelopeHelper","../../../util/Logger","JSEncrypt","amp/util/AesUtil","amp/connection/topology/DefaultMessagingKeystore","amp/connection/topology/DefaultIdentityProvider"],function(e,t,n,r,o,i,s){var a;return a=function(){function r(e){null==e&&(e={}),this.keystore=e.keystore,this.defaultIdentityProvider=e.defaultIdentityProvider,_.isObject(this.keystore)||(this.authenticationProvider=new i),_.isObject(this.defaultIdentityProvider)||(this.defaultIdentityProvider=new s)}return r.prototype.processInbound=function(){return null},r.prototype.processOutbound=function(e){var r,o;return n.log.info("EncryptedResponseHandler.processOutbound >> setting properties for encrypted response"),r=new t(e.getEnvelope()),r.isPubSub()?o=this._getPublicKey(r.getMessageTopic()):void 0},r.prototype._getPublicKey=function(t){var r,o=this;return r=e.Deferred(),this.keystore.hasKeypair(t)?(n.log.info("EncryptedResponseHandler._getPublicKey >> keystore hit, returning public key"),r.resolve(this.keystore.getPublicKey(t))):(n.log.info("EncryptedResponseHandler._getPublicKey >> keystore miss, querying identity provider"),this.defaultIdentityProvider.getIdentity(t).then(function(e){return o.keystore.setKeypair(t,e),r.resolve(o.keystore.getPublicKey(t))})),r.promise()},r}()}),define("amp/factory/ShortBus",["../bus/berico/TransportProviderFactory","../connection/topology/GlobalTopologyService","../connection/topology/SimpleTopologyService","../connection/ChannelProvider","../connection/topology/DefaultApplicationExchangeProvider","../bus/berico/EnvelopeBus","../eventing/berico/serializers/JsonEventSerializer","../eventing/berico/OutboundHeadersProcessor","../eventing/berico/EventBus","../connection/topology/RoutingInfoRetriever","underscore","../util/Logger","../bus/berico/EnvelopeHelper","../connection/topology/DefaultAuthenticationProvider","../connection/topology/DefaultIdentityProvider","../eventing/berico/RpcBus","../eventing/berico/handlers/EncryptedResponseHandler","../eventing/berico/handlers/EncryptedRequestHandler","../connection/topology/DefaultMessagingKeystore"],function(e,t,n,r,o,i,s,a,u,c,l,p,f,h,d,g,v,y,m){var b;return b=function(){function l(){}return l.BUSTYPE={RPC:"rpc",EVENT:"event"},l.TOPOLOGY_SERVICE={GTS:"GTS",SIMPLE:"SIMPLE"},l.getBus=function(p){var f,b,S,E,x,w,T,_,C,P,R,N,O,D,A,I,k,H,M,j,B,L,q,U,F,K,J,V,G,z,W,X,$,Y,Z,Q,et,tt,nt,rt,ot,it,st;return null==p&&(p={}),X=p.routingInfoHostname,$=p.routingInfoPort,Z=p.routingInfoServiceUrl,W=p.routingInfoConnectionStrategy,D=p.exchangeProviderHostname,A=p.exchangeProviderPort,I=p.exchangeProviderServiceUrl,O=p.exchangeProviderConnectionStrategy,H=p.fallbackTopoClientProfile,j=p.fallbackTopoExchangeName,M=p.fallbackTopoExchangeHostname,L=p.fallbackTopoExchangeVhost,B=p.fallbackTopoExchangePort,q=p.gtsCacheExpiryTime,U=p.gtsExchangeOverrides,C=p.channelProviderConnectionStrategy,_=p.channelProviderConnectionFactory,z=p.publishTopicOverride,S=p.authenticationProviderHostname,E=p.authenticationProviderPort,x=p.authenticationProviderServiceUrl,b=p.authenticationProviderConnectionStrategy,w=p.busType,K=p.identityProviderServiceUrl,F=p.identityProviderConnectionStrategy,V=p.messagingFactory,ot=p.topologyService,Q=p.simpleTopologyServiceClientProfile,tt=p.simpleTopologyServiceName,et=p.simpleTopologyServiceHostname,rt=p.simpleTopologyServiceVirtualHost,nt=p.simpleTopologyServicePort,Y=new c({hostname:X,port:$,serviceUrlExpression:Z,connectionStrategy:W}),k=new o({managementHostname:D,managementPort:A,managementServiceUrl:I,connectionStrategy:O,clientProfile:H,exchangeName:j,exchangeHostname:M,exchangeVhost:L,exchangePort:B}),ot===this.TOPOLOGY_SERVICE.SIMPLE?(console.log("choosing simple..."),st=new n({clientProfile:Q,name:tt,hostname:et,virtualHost:rt,port:nt})):st=new t({routingInfoRetriever:Y,cacheExpiryTime:q,fallbackProvider:k,exchangeOverrides:U}),f=new h({hostname:S,port:E,serviceUrl:x,connectionStrategy:b}),T=new r({connectionStrategy:C,connectionFactory:_,authenticationProvider:f,messagingFactory:V}),it=e.getTransportProvider({topologyService:st,transportProvider:e.TransportProviders.WebStomp,channelProvider:T}),N=new i(it),R=new m,P=new d({hostname:S,port:E,serviceUrl:K,connectionStrategy:F}),J=[new v({keystore:R}),new s],G=[new a({authenticationProvider:f}),new s,new y({keystore:R,defaultIdentityProvider:P})],w===l.BUSTYPE.RPC?new g(N,J,G):new u(N,J,G)},l}()}),define(["amp/factory/ShortBus"],function(e){return e})}();